<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeGaXi IVR v6.0 - Panel de Control</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1923; color: #e0e0e0; min-height: 100vh; }
  .header { background: linear-gradient(135deg, #1a2332, #243447); padding: 20px 30px; border-bottom: 2px solid #2d9cdb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
  .header h1 { font-size: 22px; color: #2d9cdb; }
  .header-right { display: flex; align-items: center; gap: 15px; }
  .header .balance { background: #1e3a2f; padding: 8px 16px; border-radius: 8px; color: #4caf50; font-weight: bold; font-size: 16px; }
  .status-ok { color: #4caf50; font-size: 13px; }
  .status-err { color: #e53935; font-size: 13px; }
  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
  @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
  .card { background: #1a2a3a; border-radius: 12px; padding: 20px; border: 1px solid #2a3a4a; }
  .card h2 { color: #2d9cdb; font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
  .form-group { margin-bottom: 12px; }
  .form-group label { display: block; color: #8899aa; font-size: 13px; margin-bottom: 4px; }
  .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; background: #0f1923; border: 1px solid #2a3a4a; border-radius: 8px; color: #e0e0e0; font-size: 14px; }
  .form-group textarea { height: 140px; font-family: monospace; font-size: 12px; resize: vertical; }
  .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .btn-primary { background: #2d9cdb; color: white; }
  .btn-primary:hover { background: #2488c4; }
  .btn-success { background: #4caf50; color: white; }
  .btn-success:hover { background: #43a047; }
  .btn-danger { background: #e53935; color: white; }
  .btn-danger:hover { background: #c62828; }
  .btn-warning { background: #ff9800; color: white; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-row { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
  .log { background: #0a1520; border: 1px solid #1a2a3a; border-radius: 8px; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.6; }
  .log .info { color: #2d9cdb; }
  .log .success { color: #4caf50; }
  .log .error { color: #e53935; }
  .log .warn { color: #ff9800; }
  .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
  @media (max-width: 600px) { .stats { grid-template-columns: repeat(2, 1fr); } }
  .stat-card { background: #1a2a3a; border-radius: 8px; padding: 15px; text-align: center; border: 1px solid #2a3a4a; }
  .stat-card .number { font-size: 28px; font-weight: 700; }
  .stat-card .label { font-size: 11px; color: #8899aa; margin-top: 4px; }
  .stat-card.blue .number { color: #2d9cdb; }
  .stat-card.green .number { color: #4caf50; }
  .stat-card.orange .number { color: #ff9800; }
  .stat-card.red .number { color: #e53935; }
  .results-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
  .results-table th { text-align: left; padding: 8px; color: #8899aa; border-bottom: 1px solid #2a3a4a; font-size: 11px; }
  .results-table td { padding: 8px; border-bottom: 1px solid #1a2a3a; }
  .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; }
  .badge-pending { background: #333; color: #999; }
  .badge-pago { background: #1b5e20; color: #81c784; }
  .badge-promesa { background: #e65100; color: #ffb74d; }
  .badge-asesor { background: #1565c0; color: #64b5f6; }
  .badge-contactado { background: #4a148c; color: #ce93d8; }
  .badge-no-contesto { background: #b71c1c; color: #ef9a9a; }
  .badge-error { background: #4a0000; color: #ff5252; }
  .full-width { grid-column: 1 / -1; }
  .config-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #1a2a3a; font-size: 13px; }
  .config-item .key { color: #8899aa; }
  .config-item .val { color: #e0e0e0; font-family: monospace; font-size: 12px; }
  .config-item .val.ok { color: #4caf50; }
  .config-item .val.err { color: #e53935; }
  .login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 999; }
  .login-box { background: #1a2a3a; padding: 30px; border-radius: 12px; border: 1px solid #2d9cdb; text-align: center; min-width: 320px; }
  .login-box h2 { color: #2d9cdb; margin-bottom: 20px; }
  .login-box input { width: 100%; padding: 12px; background: #0f1923; border: 1px solid #2a3a4a; border-radius: 8px; color: #e0e0e0; font-size: 16px; text-align: center; margin-bottom: 15px; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>üìû LeGaXi IVR v6.0</h2>
    <p style="color:#8899aa;margin-bottom:20px;">Ingresa la clave API</p>
    <input type="password" id="apiKeyInput" placeholder="API Key" autofocus>
    <button class="btn btn-primary" onclick="doLogin()" style="width:100%;">Entrar</button>
    <p id="loginError" style="color:#e53935;margin-top:10px;" class="hidden">Clave incorrecta</p>
  </div>
</div>

<div id="mainApp" class="hidden">
<div class="header">
  <h1>üìû LeGaXi IVR v6.0</h1>
  <div class="header-right">
    <span id="serverStatus">‚è≥</span>
    <div class="balance" id="balanceDisplay">$-.--</div>
  </div>
</div>
<div class="container">
  <div class="stats">
    <div class="stat-card blue"><div class="number" id="statTotal">0</div><div class="label">TOTAL</div></div>
    <div class="stat-card green"><div class="number" id="statContestadas">0</div><div class="label">CONTESTADAS</div></div>
    <div class="stat-card orange"><div class="number" id="statPendientes">0</div><div class="label">PENDIENTES</div></div>
    <div class="stat-card red"><div class="number" id="statNoContesto">0</div><div class="label">NO CONTEST√ì</div></div>
  </div>
  <div class="grid">
    <div class="card">
      <h2>üß™ Llamada de Prueba</h2>
      <div class="form-group"><label>Tel√©fono (10 d√≠gitos)</label><input type="tel" id="testPhone" placeholder="5544621100"></div>
      <div class="form-group"><label>Nombre</label><input type="text" id="testNombre" value="Leo Prueba"></div>
      <div class="form-group"><label>Saldo</label><input type="text" id="testSaldo" value="500"></div>
      <div class="btn-row"><button class="btn btn-primary" onclick="testCall()">üìû Llamar</button></div>
    </div>
    <div class="card">
      <h2>‚öôÔ∏è Configuraci√≥n</h2>
      <div id="configDisplay"><div class="config-item"><span class="key">Cargando...</span></div></div>
      <div class="btn-row" style="margin-top:15px;">
        <button class="btn btn-primary" onclick="loadConfig()">üîÑ Recargar</button>
        <button class="btn btn-success" onclick="loadBalance()">üí∞ Balance</button>
      </div>
    </div>
    <div class="card full-width">
      <h2>üìã Campa√±a de Llamadas</h2>
      <div class="grid" style="margin-top:0;">
        <div>
          <div class="form-group">
            <label>Lista de Clientes (JSON)</label>
            <textarea id="campaignClients" placeholder='[{"nombre":"Juan","telefono":"5544621100","saldo":"5000","diasAtraso":"30"}]'></textarea>
          </div>
          <div class="form-group"><label>Segundos entre llamadas</label><input type="number" id="campaignDelay" value="45" min="15" max="120"></div>
          <div class="btn-row">
            <button class="btn btn-success" id="btnStart" onclick="startCampaign()">üöÄ Iniciar</button>
            <button class="btn btn-danger" id="btnCancel" onclick="cancelCampaign()" disabled>‚õî Cancelar</button>
          </div>
        </div>
        <div>
          <div class="form-group"><label>Resultados</label></div>
          <div style="max-height:250px;overflow-y:auto;">
            <table class="results-table"><thead><tr><th>Nombre</th><th>Tel</th><th>Saldo</th><th>Resultado</th></tr></thead>
            <tbody id="campaignResults"><tr><td colspan="4" style="color:#666;text-align:center;">Sin campa√±a</td></tr></tbody></table>
          </div>
        </div>
      </div>
    </div>
    <div class="card full-width">
      <h2>üìù Log</h2>
      <div class="log" id="logContainer"></div>
      <div class="btn-row" style="margin-top:10px;"><button class="btn btn-primary" onclick="clearLog()">üóëÔ∏è Limpiar</button></div>
    </div>
  </div>
</div>
</div>

<script>
const BASE = window.location.origin;
let KEY = '';
let campaignId = null;
let poller = null;

function api(path) {
  const s = path.includes('?') ? '&' : '?';
  return `${BASE}${path}${s}api_key=${encodeURIComponent(KEY)}`;
}

function log(m, t='info') {
  const el = document.getElementById('logContainer');
  el.innerHTML += `<div class="${t}">[${new Date().toLocaleTimeString()}] ${m}</div>`;
  el.scrollTop = el.scrollHeight;
}

function badge(r) {
  if (!r || r==='pendiente') return 'badge-pending';
  if (r.includes('pago') && !r.includes('promesa')) return 'badge-pago';
  if (r.includes('promesa')) return 'badge-promesa';
  if (r.includes('asesor')) return 'badge-asesor';
  if (r.includes('contactado')) return 'badge-contactado';
  if (r.includes('no_contesto')||r.includes('sin_resp')) return 'badge-no-contesto';
  return 'badge-error';
}

function doLogin() {
  const k = document.getElementById('apiKeyInput').value.trim();
  if (!k) return;
  KEY = k;
  fetch(api('/api/config')).then(r => {
    if (!r.ok) throw 0;
    return r.json();
  }).then(() => {
    document.getElementById('loginOverlay').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    localStorage.setItem('lgx_key', KEY);
    init();
  }).catch(() => {
    document.getElementById('loginError').classList.remove('hidden');
  });
}
document.getElementById('apiKeyInput').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

async function loadConfig() {
  try {
    const d = await (await fetch(api('/api/config'))).json();
    const el = document.getElementById('configDisplay');
    el.innerHTML = [
      ['API Zadarma', d.zadarma?.configured ? '‚úÖ OK' : '‚ùå', d.zadarma?.configured ? 'ok' : 'err'],
      ['Extensi√≥n', d.zadarma?.sip || '-', ''],
      ['CallerID', d.zadarma?.callerId || '-', ''],
      ['Escenario', d.zadarma?.scenario || '-', ''],
      ['GAS', d.gas?.configured ? '‚úÖ OK' : '‚ùå Sin config', d.gas?.configured ? 'ok' : 'err'],
      ['Webhook', d.webhookUrl ? '‚úÖ' : '‚ùå', d.webhookUrl ? 'ok' : 'err'],
    ].map(([k,v,c]) => `<div class="config-item"><span class="key">${k}</span><span class="val ${c}">${v}</span></div>`).join('');
    document.getElementById('serverStatus').innerHTML = '<span class="status-ok">üü¢ Online</span>';
    log('Config cargada', 'success');
  } catch(e) {
    document.getElementById('serverStatus').innerHTML = '<span class="status-err">üî¥ Error</span>';
    log('Error config: '+e.message, 'error');
  }
}

async function loadBalance() {
  try {
    const d = await (await fetch(api('/api/balance'))).json();
    document.getElementById('balanceDisplay').textContent = `$${d.balance??'?'} ${d.currency||'USD'}`;
    log(`üí∞ Balance: $${d.balance} ${d.currency||'USD'}`, 'success');
  } catch(e) { log('Error balance: '+e.message, 'error'); }
}

async function testCall() {
  const phone = document.getElementById('testPhone').value.trim();
  const nombre = document.getElementById('testNombre').value.trim() || 'Prueba';
  const saldo = document.getElementById('testSaldo').value.trim() || '500';
  if (!phone || phone.length < 10) { log('‚ö†Ô∏è Tel√©fono inv√°lido', 'error'); return; }
  log(`üìû Llamando a ${nombre} (${phone})...`, 'info');
  try {
    const d = await (await fetch(api('/api/test-call'), {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({phone, nombre, saldo})
    })).json();
    if (d.success) log(`‚úÖ Llamada enviada a ${phone}`, 'success');
    else log(`‚ùå ${d.result?.message || JSON.stringify(d)}`, 'error');
  } catch(e) { log('‚ùå '+e.message, 'error'); }
}

async function startCampaign() {
  let clients;
  try { clients = JSON.parse(document.getElementById('campaignClients').value); }
  catch(e) { log('‚ùå JSON inv√°lido', 'error'); return; }
  if (!Array.isArray(clients)||!clients.length) { log('‚ùå Array vac√≠o', 'error'); return; }
  const delay = parseInt(document.getElementById('campaignDelay').value) || 45;
  log(`üöÄ Campa√±a: ${clients.length} clientes, ${delay}s delay`, 'info');
  try {
    const d = await (await fetch(api('/api/campaign'), {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({clients, delaySeconds: delay})
    })).json();
    if (d.campaignId) {
      campaignId = d.campaignId;
      log(`‚úÖ Campa√±a ${d.campaignId} iniciada`, 'success');
      document.getElementById('btnStart').disabled = true;
      document.getElementById('btnCancel').disabled = false;
      poller = setInterval(poll, 5000);
      poll();
    } else log('‚ùå '+JSON.stringify(d), 'error');
  } catch(e) { log('‚ùå '+e.message, 'error'); }
}

async function cancelCampaign() {
  if (!campaignId) return;
  await fetch(api(`/api/campaign/${campaignId}/cancel`), {method:'POST'});
  log(`‚õî Campa√±a cancelada`, 'warn');
  stopPoll();
}

async function poll() {
  if (!campaignId) return;
  try {
    const d = await (await fetch(api(`/api/campaign/${campaignId}`))).json();
    let ok=0, no=0, pend=0;
    (d.clients||[]).forEach(c => {
      if (c.resultado==='pendiente') pend++;
      else if (['pago','promesa_pago','asesor','contactado_sin_seleccion'].includes(c.resultado)) ok++;
      else no++;
    });
    document.getElementById('statTotal').textContent = d.total||0;
    document.getElementById('statContestadas').textContent = ok;
    document.getElementById('statPendientes').textContent = pend;
    document.getElementById('statNoContesto').textContent = no;
    document.getElementById('campaignResults').innerHTML = (d.clients||[]).map(c =>
      `<tr><td>${c.nombre||'-'}</td><td>${c.telefono||'-'}</td><td>$${c.saldo||'-'}</td><td><span class="badge ${badge(c.resultado)}">${c.resultado||'pendiente'}</span></td></tr>`
    ).join('');
    if (d.completed >= d.total || d.cancelled) {
      log(`üìä Fin: ${ok} contactados, ${no} sin respuesta`, d.cancelled?'warn':'success');
      stopPoll();
    }
  } catch(e) {}
}

function stopPoll() {
  if (poller) { clearInterval(poller); poller=null; }
  campaignId = null;
  document.getElementById('btnStart').disabled = false;
  document.getElementById('btnCancel').disabled = true;
}

function clearLog() { document.getElementById('logContainer').innerHTML=''; }

function init() { loadConfig(); loadBalance(); log('Panel inicializado ‚úÖ', 'success'); }

window.addEventListener('DOMContentLoaded', () => {
  const u = new URLSearchParams(window.location.search).get('api_key');
  const s = localStorage.getItem('lgx_key');
  const k = u || s;
  if (k) {
    KEY = k;
    fetch(api('/api/config')).then(r => {
      if (!r.ok) throw 0;
      return r.json();
    }).then(() => {
      document.getElementById('loginOverlay').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      localStorage.setItem('lgx_key', KEY);
      init();
    }).catch(() => {});
  }
});
</script>
</body>
</html>
