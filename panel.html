<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeGaXi IVR v6.0 - Panel de Control</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1923; color: #e0e0e0; min-height: 100vh; }

  .header { background: linear-gradient(135deg, #1a2332, #243447); padding: 20px 30px; border-bottom: 2px solid #2d9cdb; display: flex; justify-content: space-between; align-items: center; }
  .header h1 { font-size: 22px; color: #2d9cdb; }
  .header .balance { background: #1e3a2f; padding: 8px 16px; border-radius: 8px; color: #4caf50; font-weight: bold; font-size: 16px; }

  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
  @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }

  .card { background: #1a2a3a; border-radius: 12px; padding: 20px; border: 1px solid #2a3a4a; }
  .card h2 { color: #2d9cdb; font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

  .form-group { margin-bottom: 12px; }
  .form-group label { display: block; color: #8899aa; font-size: 13px; margin-bottom: 4px; }
  .form-group input, .form-group textarea, .form-group select {
    width: 100%; padding: 10px; background: #0f1923; border: 1px solid #2a3a4a;
    border-radius: 8px; color: #e0e0e0; font-size: 14px;
  }
  .form-group textarea { height: 120px; font-family: monospace; font-size: 12px; resize: vertical; }

  .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .btn-primary { background: #2d9cdb; color: white; }
  .btn-primary:hover { background: #2488c4; }
  .btn-success { background: #4caf50; color: white; }
  .btn-success:hover { background: #43a047; }
  .btn-danger { background: #e53935; color: white; }
  .btn-danger:hover { background: #c62828; }
  .btn-warning { background: #ff9800; color: white; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-row { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }

  .log { background: #0a1520; border: 1px solid #1a2a3a; border-radius: 8px; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.6; }
  .log .info { color: #2d9cdb; }
  .log .success { color: #4caf50; }
  .log .error { color: #e53935; }
  .log .warn { color: #ff9800; }

  .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
  .stat-card { background: #1a2a3a; border-radius: 8px; padding: 15px; text-align: center; border: 1px solid #2a3a4a; }
  .stat-card .number { font-size: 28px; font-weight: 700; }
  .stat-card .label { font-size: 11px; color: #8899aa; margin-top: 4px; }
  .stat-card.blue .number { color: #2d9cdb; }
  .stat-card.green .number { color: #4caf50; }
  .stat-card.orange .number { color: #ff9800; }
  .stat-card.red .number { color: #e53935; }

  .results-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
  .results-table th { text-align: left; padding: 8px; color: #8899aa; border-bottom: 1px solid #2a3a4a; font-size: 11px; }
  .results-table td { padding: 8px; border-bottom: 1px solid #1a2a3a; }
  .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .badge-pending { background: #333; color: #999; }
  .badge-pago { background: #1b5e20; color: #81c784; }
  .badge-promesa { background: #e65100; color: #ffb74d; }
  .badge-asesor { background: #1565c0; color: #64b5f6; }
  .badge-no-contesto { background: #b71c1c; color: #ef9a9a; }
  .badge-error { background: #4a0000; color: #ff5252; }

  .full-width { grid-column: 1 / -1; }

  .config-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #1a2a3a; font-size: 13px; }
  .config-item .key { color: #8899aa; }
  .config-item .val { color: #e0e0e0; font-family: monospace; }
  .config-item .val.ok { color: #4caf50; }
  .config-item .val.err { color: #e53935; }

  .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
  .status-dot.online { background: #4caf50; }
  .status-dot.offline { background: #e53935; }
</style>
</head>
<body>

<div class="header">
  <h1>üìû LeGaXi IVR v6.0 - Panel de Control</h1>
  <div class="balance" id="balanceDisplay">$-.--</div>
</div>

<div class="container">
  <!-- Stats -->
  <div class="stats">
    <div class="stat-card blue">
      <div class="number" id="statTotal">0</div>
      <div class="label">TOTAL LLAMADAS</div>
    </div>
    <div class="stat-card green">
      <div class="number" id="statContestadas">0</div>
      <div class="label">CONTESTADAS</div>
    </div>
    <div class="stat-card orange">
      <div class="number" id="statPendientes">0</div>
      <div class="label">PENDIENTES</div>
    </div>
    <div class="stat-card red">
      <div class="number" id="statNoContesto">0</div>
      <div class="label">NO CONTEST√ì</div>
    </div>
  </div>

  <div class="grid">
    <!-- Llamada de Prueba -->
    <div class="card">
      <h2>üß™ Llamada de Prueba</h2>
      <div class="form-group">
        <label>Tel√©fono (10 d√≠gitos)</label>
        <input type="tel" id="testPhone" placeholder="5544621100">
      </div>
      <div class="form-group">
        <label>Nombre</label>
        <input type="text" id="testNombre" placeholder="Juan P√©rez">
      </div>
      <div class="form-group">
        <label>Saldo</label>
        <input type="text" id="testSaldo" placeholder="5000">
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="testCall()">üìû Llamar</button>
      </div>
    </div>

    <!-- Configuraci√≥n -->
    <div class="card">
      <h2>‚öôÔ∏è Configuraci√≥n del Servidor</h2>
      <div id="configDisplay">
        <div class="config-item"><span class="key">Cargando...</span></div>
      </div>
      <div class="btn-row" style="margin-top:15px;">
        <button class="btn btn-primary" onclick="loadConfig()">üîÑ Recargar</button>
        <button class="btn btn-success" onclick="loadBalance()">üí∞ Balance</button>
      </div>
    </div>

    <!-- Campa√±a Masiva -->
    <div class="card full-width">
      <h2>üìã Campa√±a de Llamadas</h2>
      <div class="grid" style="margin-top:0;">
        <div>
          <div class="form-group">
            <label>Lista de Clientes (JSON)</label>
            <textarea id="campaignClients" placeholder='[
  {"nombre":"Juan P√©rez","telefono":"5544621100","saldo":"5000","diasAtraso":"30"},
  {"nombre":"Mar√≠a L√≥pez","telefono":"5544621101","saldo":"3000","diasAtraso":"15"}
]'></textarea>
          </div>
          <div class="form-group">
            <label>Segundos entre llamadas</label>
            <input type="number" id="campaignDelay" value="30" min="15" max="120">
          </div>
          <div class="btn-row">
            <button class="btn btn-success" id="btnStartCampaign" onclick="startCampaign()">üöÄ Iniciar Campa√±a</button>
            <button class="btn btn-danger" id="btnCancelCampaign" onclick="cancelCampaign()" disabled>‚õî Cancelar</button>
            <button class="btn btn-warning" onclick="loadFromGAS()">üìä Cargar desde GAS</button>
          </div>
        </div>
        <div>
          <div class="form-group">
            <label>Resultados de Campa√±a</label>
          </div>
          <div style="max-height:250px; overflow-y:auto;">
            <table class="results-table">
              <thead>
                <tr><th>Nombre</th><th>Tel√©fono</th><th>Saldo</th><th>Resultado</th></tr>
              </thead>
              <tbody id="campaignResults">
                <tr><td colspan="4" style="color:#666;text-align:center;">Sin campa√±a activa</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Log -->
    <div class="card full-width">
      <h2>üìù Log de Actividad</h2>
      <div class="log" id="logContainer"></div>
      <div class="btn-row" style="margin-top:10px;">
        <button class="btn btn-primary" onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = window.location.origin;
const API_KEY_HEADER = ''; // Poner tu API_KEY si configuraste una
let currentCampaignId = null;
let pollInterval = null;

function headers() {
  const h = { 'Content-Type': 'application/json' };
  if (API_KEY_HEADER) h['x-api-key'] = API_KEY_HEADER;
  return h;
}

function log(msg, type = 'info') {
  const el = document.getElementById('logContainer');
  const time = new Date().toLocaleTimeString();
  el.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}

function badgeClass(resultado) {
  if (!resultado || resultado === 'pendiente') return 'badge-pending';
  if (resultado.includes('pago')) return 'badge-pago';
  if (resultado.includes('promesa')) return 'badge-promesa';
  if (resultado.includes('asesor')) return 'badge-asesor';
  if (resultado.includes('no_contesto') || resultado.includes('cancelar')) return 'badge-no-contesto';
  if (resultado.includes('error') || resultado.includes('timeout')) return 'badge-error';
  return 'badge-pending';
}

async function loadConfig() {
  try {
    const res = await fetch(`${API_BASE}/api/config`, { headers: headers() });
    const data = await res.json();
    const el = document.getElementById('configDisplay');
    el.innerHTML = '';

    const items = [
      ['Versi√≥n', data.version, 'ok'],
      ['API Zadarma', data.zadarma?.configured ? '‚úÖ Configurada' : '‚ùå Falta', data.zadarma?.configured ? 'ok' : 'err'],
      ['Extensi√≥n SIP', data.zadarma?.sip || '-', ''],
      ['CallerID', data.zadarma?.callerId || '-', ''],
      ['Escenario', data.zadarma?.scenario || '-', ''],
      ['IVR Audio', data.zadarma?.ivrFileId || 'TTS', ''],
      ['GAS Webhook', data.gas?.configured ? '‚úÖ' : '‚ùå', data.gas?.configured ? 'ok' : 'err'],
      ['Webhook URL', data.webhookUrl || '-', ''],
      ['Llamadas activas', data.activeCalls || 0, ''],
      ['Campa√±as', data.activeCampaigns || 0, ''],
    ];

    items.forEach(([key, val, cls]) => {
      el.innerHTML += `<div class="config-item"><span class="key">${key}</span><span class="val ${cls}">${val}</span></div>`;
    });

    log('Configuraci√≥n cargada', 'success');
  } catch (e) {
    log(`Error cargando config: ${e.message}`, 'error');
  }
}

async function loadBalance() {
  try {
    const res = await fetch(`${API_BASE}/api/balance`, { headers: headers() });
    const data = await res.json();
    const bal = data.balance || data.value || '?';
    const currency = data.currency || 'USD';
    document.getElementById('balanceDisplay').textContent = `$${bal} ${currency}`;
    log(`Balance: $${bal} ${currency}`, 'success');
  } catch (e) {
    log(`Error balance: ${e.message}`, 'error');
  }
}

async function testCall() {
  const phone = document.getElementById('testPhone').value.trim();
  const nombre = document.getElementById('testNombre').value.trim() || 'Prueba';
  const saldo = document.getElementById('testSaldo').value.trim() || '1000';

  if (!phone || phone.length < 10) {
    log('Tel√©fono inv√°lido (m√≠nimo 10 d√≠gitos)', 'error');
    return;
  }

  log(`Llamando a ${nombre} (${phone})...`, 'info');

  try {
    const res = await fetch(`${API_BASE}/api/test-call`, {
      method: 'POST',
      headers: headers(),
      body: JSON.stringify({ phone, nombre, saldo })
    });
    const data = await res.json();

    if (data.success) {
      log(`‚úÖ Llamada enviada exitosamente`, 'success');
    } else {
      log(`‚ùå Error: ${JSON.stringify(data.error || data.result)}`, 'error');
    }
  } catch (e) {
    log(`‚ùå Error: ${e.message}`, 'error');
  }
}

async function startCampaign() {
  let clients;
  try {
    clients = JSON.parse(document.getElementById('campaignClients').value);
  } catch (e) {
    log('JSON inv√°lido en la lista de clientes', 'error');
    return;
  }

  if (!Array.isArray(clients) || !clients.length) {
    log('La lista debe ser un array con al menos 1 cliente', 'error');
    return;
  }

  const delay = parseInt(document.getElementById('campaignDelay').value) || 30;
  log(`üöÄ Iniciando campa√±a: ${clients.length} clientes, delay=${delay}s`, 'info');

  try {
    const res = await fetch(`${API_BASE}/api/campaign`, {
      method: 'POST',
      headers: headers(),
      body: JSON.stringify({ clients, delaySeconds: delay })
    });
    const data = await res.json();

    if (data.campaignId) {
      currentCampaignId = data.campaignId;
      log(`‚úÖ Campa√±a ${data.campaignId} iniciada (${data.total} clientes)`, 'success');

      document.getElementById('btnStartCampaign').disabled = true;
      document.getElementById('btnCancelCampaign').disabled = false;

      // Poll cada 5 segundos
      pollInterval = setInterval(pollCampaign, 5000);
      pollCampaign();
    } else {
      log(`‚ùå Error: ${JSON.stringify(data)}`, 'error');
    }
  } catch (e) {
    log(`‚ùå Error: ${e.message}`, 'error');
  }
}

async function cancelCampaign() {
  if (!currentCampaignId) return;
  try {
    await fetch(`${API_BASE}/api/campaign/${currentCampaignId}/cancel`, {
      method: 'POST', headers: headers()
    });
    log(`‚õî Campa√±a ${currentCampaignId} cancelada`, 'warn');
    stopPolling();
  } catch (e) {
    log(`Error cancelando: ${e.message}`, 'error');
  }
}

async function pollCampaign() {
  if (!currentCampaignId) return;
  try {
    const res = await fetch(`${API_BASE}/api/campaign/${currentCampaignId}`, { headers: headers() });
    const data = await res.json();

    // Update stats
    let contestadas = 0, noContesto = 0, pendientes = 0;
    data.clients.forEach(c => {
      if (c.resultado === 'pendiente') pendientes++;
      else if (['pago', 'promesa_pago', 'asesor', 'contactado_sin_seleccion'].includes(c.resultado)) contestadas++;
      else noContesto++;
    });

    document.getElementById('statTotal').textContent = data.total;
    document.getElementById('statContestadas').textContent = contestadas;
    document.getElementById('statPendientes').textContent = pendientes;
    document.getElementById('statNoContesto').textContent = noContesto;

    // Update table
    const tbody = document.getElementById('campaignResults');
    tbody.innerHTML = data.clients.map(c => `
      <tr>
        <td>${c.nombre}</td>
        <td>${c.telefono}</td>
        <td>$${c.saldo || '-'}</td>
        <td><span class="badge ${badgeClass(c.resultado)}">${c.resultado}</span></td>
      </tr>
    `).join('');

    // Check if complete
    if (data.completed >= data.total || data.cancelled) {
      log(`üìä Campa√±a finalizada: ${contestadas} contactados, ${noContesto} sin respuesta`, data.cancelled ? 'warn' : 'success');
      stopPolling();
    }
  } catch (e) {
    // silently retry
  }
}

function stopPolling() {
  if (pollInterval) {
    clearInterval(pollInterval);
    pollInterval = null;
  }
  document.getElementById('btnStartCampaign').disabled = false;
  document.getElementById('btnCancelCampaign').disabled = true;
}

async function loadFromGAS() {
  log('‚ö†Ô∏è Para cargar clientes desde GAS, configura el endpoint en tu Google Apps Script', 'warn');
  log('El formato esperado es un array JSON con: nombre, telefono, saldo, diasAtraso, promotor, cobrador', 'info');
}

function clearLog() {
  document.getElementById('logContainer').innerHTML = '';
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  loadConfig();
  loadBalance();
  log('Panel LeGaXi IVR v6.0 inicializado', 'success');
});
</script>
</body>
</html>
